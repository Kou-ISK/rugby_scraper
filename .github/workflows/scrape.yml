name: Scrape Rugby Matches

on:
  schedule:
    - cron: "0 0 * * 0" # 毎週UTC 00:00に実行（日曜）
  workflow_dispatch: # 手動実行用
    inputs:
      scraper:
        description: "Run a specific scraper or 'all'"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - six-nations
          - six-nations-women
          - six-nations-u20
          - epcr-challenge
          - epcr-champions
          - top14
          - league-one
          - gallagher-premiership
          - urc
          - super-rugby-pacific
          - world-rugby-internationals

permissions:
  contents: write

jobs:
  scrape-matches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: data
          persist-credentials: true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      - name: Debug Python environment
        run: |
          echo "Current working directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Python path:"
          python -c "import sys; print('\n'.join(sys.path))"
          echo "PYTHONPATH environment variable:"
          echo $PYTHONPATH
          echo "src directory contents:"
          ls -la src/
          echo "src/__init__.py exists:" $(test -f src/__init__.py && echo "Yes" || echo "No")
          echo "src/metadata/__init__.py exists:" $(test -f src/metadata/__init__.py && echo "Yes" || echo "No")
      - name: Run scrapers
        env:
          PYTHONPATH: .
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.scraper }}" != "all" ]; then
            python -m src.main "${{ inputs.scraper }}"
          else
            python -m src.main six-nations
            python -m src.main six-nations-women
            python -m src.main six-nations-u20
            python -m src.main epcr-challenge
            python -m src.main epcr-champions
            python -m src.main top14
            python -m src.main league-one
            python -m src.main gallagher-premiership
            python -m src.main urc
            python -m src.main super-rugby-pacific
            python -m src.main world-rugby-internationals
          fi
      - name: Generate competitions metadata
        env:
          PYTHONPATH: .
        run: |
          cd ${{ github.workspace }}
          python -m src.metadata.generate_competitions || python src/metadata/generate_competitions.py
      - name: Commit and push if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/matches/ data/competitions.json
          git diff --cached --quiet || git commit -m "Update match data"
          git pull --rebase origin data
          git push origin data
