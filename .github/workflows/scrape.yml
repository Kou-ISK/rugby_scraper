name: Scrape Rugby Matches

on:
  schedule:
    - cron: "0 0 * * 0" # 毎週UTC 00:00に実行（日曜）
  workflow_dispatch: # 手動実行用
    inputs:
      scraper:
        description: "Run a specific scraper or 'all'"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - six-nations
          - six-nations-women
          - six-nations-u20
          - epcr-challenge
          - epcr-champions
          - top14
          - league-one
          - gallagher-premiership
          - urc
          - super-rugby-pacific
          - world-rugby-internationals

permissions:
  contents: write

jobs:
  scrape-matches:
    runs-on: ubuntu-latest
    steps:
      # mainブランチをチェックアウト（コードを取得）
      - uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: true
          fetch-depth: 0 # 全履歴を取得

      # dataブランチのdataディレクトリを取得
      - name: Fetch data from data branch
        run: |
          git fetch origin data:data
          git checkout data -- data/ || mkdir -p data/matches
          git checkout main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Run scrapers
        env:
          PYTHONPATH: .
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.scraper }}" != "all" ]; then
            python -m src.main "${{ inputs.scraper }}"
          else
            python -m src.main six-nations
            python -m src.main six-nations-women
            python -m src.main six-nations-u20
            python -m src.main epcr-challenge
            python -m src.main epcr-champions
            python -m src.main top14
            python -m src.main league-one
            python -m src.main gallagher-premiership
            python -m src.main urc
            python -m src.main super-rugby-pacific
            python -m src.main world-rugby-internationals
          fi
      - name: Generate competitions metadata
        run: |
          python -m src.metadata.generate_competitions

      # dataブランチに変更をプッシュ
      - name: Commit and push changes to data branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # 変更があるか確認
          if [ -n "$(git status --porcelain data/)" ]; then
            echo "Changes detected, preparing to push to data branch"
            
            # data/ディレクトリを一時ディレクトリにコピー
            cp -r data /tmp/scraped_data
            
            # dataブランチに切り替え
            git fetch origin data:data
            git checkout data
            
            # dataブランチのdata/ディレクトリを完全上書き（既存JSONは削除）
            rm -rf data
            mv /tmp/scraped_data data
            
            # コミット＆プッシュ
            git add data/
            git commit -m "Update match data - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin data
            
            echo "Successfully pushed to data branch"
          else
            echo "No changes to commit"
          fi
